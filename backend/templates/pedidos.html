<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Pedidos</title>
</head>
<body>
    <h1>Pedidos</h1>

    <button onclick="exibirFormularioCriacao()">Criar Pedido</button>

    <div id="formularioCriacao" style="display:none;">
        <h2>Criar Pedido</h2>
        <form id="formNovoPedido">
            <label for="clienteId">ID Cliente:</label>
            <input type="number" id="clienteId" name="clienteId" required><br><br>

            <div id="itens">
                <div class="item">
                    <h3>Item 1</h3>
                    <label for="nome">Nome:</label>
                    <input type="text" class="nome" required><br><br>
                    <label for="precoUnitario">Preço Unitário:</label>
                    <input type="number" class="preco_unitario" required><br><br>
                    <label for="quantidade">Quantidade:</label>
                    <input type="number" class="quantidade" required><br><br>
                </div>
            </div>

            <button type="button" onclick="adicionarItem()">Adicionar Item</button><br><br>
            <button type="button" onclick="enviarPedido()">Enviar Pedido</button>
        </form>
    </div>

    <div id="pedidos"></div>

    <script>
        let itensCount = 1;

        function adicionarItem() {
            itensCount++;
            const novoItem = document.createElement('div');
            novoItem.classList.add('item');
            novoItem.innerHTML = `
                <h3>Item ${itensCount}</h3>
                <label for="nome">Nome:</label>
                <input type="text" class="nome" required><br><br>
                <label for="precoUnitario">Preço Unitário:</label>
                <input type="number" class="preco_unitario" required><br><br>
                <label for="quantidade">Quantidade:</label>
                <input type="number" class="quantidade" required><br><br>
            `;
            document.getElementById('itens').appendChild(novoItem);
        }

        function exibirFormularioCriacao() {
            document.getElementById('formularioCriacao').style.display = 'block';
        }

        async function enviarPedido() {
            const clienteId = document.getElementById('clienteId').value;
            const itens = [];

            const itensElementos = document.querySelectorAll('.item');
            for (const itemElement of itensElementos) {
                const nome = itemElement.querySelector('.nome').value;
                const preco = parseFloat(itemElement.querySelector('.preco_unitario').value);
                const quantidade = parseInt(itemElement.querySelector('.quantidade').value);

                if (isNaN(preco) || preco <= 0 || isNaN(quantidade) || quantidade <= 0) {
                    alert("Preço e Quantidade devem ser valores válidos!");
                    return;
                }

                itens.push({ nome, preco_unitario: preco, quantidade });
            }

            const response = await fetch('/pedidos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cliente_id: clienteId, itens })
            });

            const result = await response.json();
            if (response.ok) {
                alert(result.message);
                document.getElementById('formularioCriacao').reset();
                document.getElementById('formularioCriacao').style.display = 'none';
            } else {
                alert(result.error);
            }
        }
    </script>
</body>
</html>
